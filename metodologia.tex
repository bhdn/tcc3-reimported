%
% Metodologia
%
%
% - diagramas de contexto descrevendo quais serão as informações de
%   entrada, qual módulo do software fará o processamento e como serão
%   disponibilizadas as informações da predição,
% - diagrama de classes para a implementação do software,
% 
% - descrição de quais técnicas serão utilizadas e como serão implementadas,
% - descrição de um protocolo para avaliação do desempenho das técnicas
% implementadas.
%
%

\chapter{Metodologia de desenvolvimento}\label{sec:meto}

\section{Introdução}

% Em um ambiente de virtualização gerenciado pela ferramenta \libvirt{}
% (apresentada na seção \ref{sec:libvirt}), o software executará em plano de
% fundo (ou seja, será um \emph{daemon}) e estará periodicamente coletando
% informações quantitativas a respeito do tempo de uso de processador de
% cada uma das máquinas virtuais que fazem parte de um determinado
% \emph{domínio}. Este utilizará tais informações para treinar um
% mecanismo de aprendizado de máquina. Utilizando este mecanismo, a
% ferramenta poderá então prever em quais situações alguma máquina virtual
% exigirá mais uso de processador que a máquina \emph{host} em que ela
% executa terá condições de atender sem prejudicar as outras.

A figura \ref{fig:hostguests1} apresenta um ambiente de virtualização
mínimo, aonde tem-se um computador, denominado \texttt{host}, que está
hospedando três máquinas virtuais \texttt{mv-1}, \texttt{mv-2} e
\texttt{mv-3}. Estas máquinas virtuais estão sendo gerenciadas por qualquer
uma das ferramentas que são suportadas pela \libvirt{}, e cada uma delas
pode estar executando qualquer sistema operacional, e nestes podem estar
executando qualquer tipo de software, mais comumente servidores de banco de
dados e aplicações Web.

\begin{figure}[htp]
\centering
\includegraphics{img-host-guests1.pdf}
\figinfo{Um \emph{host} e várias máquinas virtuais (\emph{guests})}{autoria própria}
\label{fig:hostguests1}
\end{figure}

Se o indivíduo que criou este ambiente esperava que as aplicações que
executam dentro das máquinas virtuais tenham um \emph{bom desempenho},
então ele deve ter estudado os usos de processador, memória e entrada/saída
dessas aplicações e dimensionado o ambiente de tal maneira que uma máquina
virtual não degrade o desempenho de outra a ponto de torná-lo inaceitável.

\begin{figure}[htp]
\centering
\includegraphics{img-host-guests2.pdf}
\figinfo{Um \emph{host} e várias máquinas virtuais (\emph{guests})}{autoria própria}
\label{fig:hostguests2}
\end{figure}

Porém, à medida que mais máquinas virtuais forem necessárias, como é
apresentado na figura \ref{fig:hostguests2}, novas máquinas físicas terão
que ser alocadas para acomodar as novas demandas. E a partir deste ponto
gerenciar este parque computacional começa a tornar-se uma tarefa
desafiadora, pois é necessário tentar acomodar tais máquinas virtuais
levando em conta as necessidades particulares de cada aplicação que estão
executando nelas.

\begin{figure}[htp]
\centering
\includegraphics{img-host-guests3.pdf}
\figinfo{Dois hóspedeiros e carga de CPU aceitável das MVs}{autoria própria}
\label{fig:hostguests3}
\end{figure}

Na figura \ref{fig:hostguests3}, a máquina \texttt{host3} possui cinco máquinas
virtuais que ocupam, ao todo, 57\% do tempo de processamento. Se estas
máquinas virtuais mantiverem o mesmo comportamento no decorrer do tempo de
vida deste ambiente, a única mudança necessária seria de talvez desligar
\texttt{host1} e migrar estas máquinas virtuais para \texttt{host3}, já que
este hospedeiro ainda tem aproximadamente 43\% de tempo de processamento
sendo desperdiçado. Sendo \texttt{host1} desligada, haveriam menos custos
com energia e manutenção.

Porém, os serviços que executam nestas máquinas virtuais podem sofrer um
abrupto aumento de demanda, o que é mais ainda provável em aplicações que
estão acessíveis por meio da Internet, como servidores web, ou serviços
relacionados, como servidores de banco de dados. Nestes casos, o
adminstrador do ambiente precisa provisionar rapidamente recursos para
atender a essa demanda.

\begin{figure}[htp]
\centering
\includegraphics{img-host-guests4.pdf}
\figinfo{Dois hóspedeiros e carga das MVs desbalanceada entre eles}{autoria própria}
\label{fig:hostguests4}
\end{figure}

No exemplo da figura \ref{fig:hostguests4}, a máquina virtual
\texttt{vm-11} está executando algum processo que está exigindo muito tempo
de CPU. Este tipo de situação pode ocorrer quando há este processo é
\emph{CPU-bound} (que faz uso intensivo do processador), o que geralmente
pode ser uma tarefa rotineira de backup (compressão, descompressão ou
sincronização de árvores) ou o rotinas aritméticas. Neste caso fica claro
que seria melhor ter esta máquina executando no hospedeiro \texttt{host1},
pois o uso típico de CPU das máquinas virtuais que já estão lá ainda pode
acomodar \texttt{vm-11}. A dificuldade neste modelo está no fato de que
este uso de CPU pode ser sazonal, e que outras máquinas virtuais além de
\texttt{vm-11} podem ter situações de demanda abrupta.

Com isso, o software que será desenvolvido a partir deste projeto atuará
tentando prever o comportamento destas máquinas virtuais e requisitando à
ferramenta de virtualização que migre aquelas que apresentarem perspectiva
de uso intensivo de CPU para um hospedeiro que tenha condições de tratar
aquela demanda.

\begin{figure}[htp]
\centering
\includegraphics{img-libvirt-contexto0.pdf}
\figinfo{libVirt e projeto}{autoria própria}
\label{fig:libvirtcontexto0}
\end{figure}

De maneira a ser útil para o maior número de usuários de ferramentas de
virtualização, este projeto utilizará a ferramenta \libvirt{} como
interface para controle e migração das máquinas virtuais, pois esta possui
suporte às principais softwares disponíveis atualmente, como descrito na
seção \ref{sec:libvirt}. A figura \ref{fig:libvirtcontexto0} descreve de
maneira superficial como será a interação entre o software a ser
implementado e a \libvirt{}. O software estará periodicamente coletando
informações a respeito de uso de CPU das máquinas virtuais sendo
gerenciadas (1). E com essas informações, o software fará predições a
respeito do comportamento destas máquinas virtuais e então enviará comandos
por meio da API (\emph{Application Programming Interface}, Interface de
Programação de Aplicação) da \libvirt{} (2), comandos estes indicando qual
máquina virtual deve migrar para qual máquina hospedeira. A \libvirt{} por
sua vez comunicará a ferramenta de virtualização (3) que então executará a
migração entre um hospedeiro e outro (4).

% colocar aqui um ou mais diagramas descrevendo as máquinas virtuais que
% estão em um ambiente "folgado" e então indicar uma situação em que uma
% máquina virtual precisa ser migrada e daí migrar para outra máquina.

\section{Modelagem do software}

\begin{figure}[htp]
\centering
\includegraphics{img-met-contexto-0.pdf}
\figinfo{Diagrama de contexto, nível 0, interação entre as principais entidades no
sistema}{autoria própria}
\label{fig:contexto0}
\end{figure}

A figura \ref{fig:contexto0} apresenta um diagrama de contexto, de nível 0,
indicando a relação entre o projeto que será desenvolvido e a biblioteca
\libvirt{}. O fluxo \texttt{estatísticas das máq. virtuais} indica as
informações a respeito de uso de CPU que são providas pela libVirt,
enquanto que \texttt{cmds. de migração} indica os comandos, transmitidos
por meio da API (introduzida na seção \ref{sec:libvirtapi}), que são enviadas
à \libvirt{} para a migração das máquinas virtuais, de acordo com o que o
software a ser implementado decidir.

\begin{figure}[htp]
\centering
\includegraphics{img-met-contexto-1.pdf}
\figinfo{Diagrama de contexto, nível 1, interação entre os processos do
projeto proposto}{autoria própria}
\label{fig:contexto1}
\end{figure}

Como o projeto será implementado utilizando o conceito de \emph{orientação a
objetos}~\cite{ricarte2001programacao}, a figura \ref{fig:contexto1} maximiza o
processo \texttt{Projeto} utilizando um diagrama de
classes~\cite{bezerra2002principios} descrevendo quais são os processos que
fazem parte do software proposto. O fluxo \texttt{uso de CPU máq. virtuais}
(também abreviado como \texttt{usos de CPU}) indica os valores que serão lidos
periodicamente de cada máquina virtual.  O processo \texttt{Coleta} trata da
consulta à instância da \libvirt{} e o pré-processamento dos dados para envio à
base. O processo \texttt{Treinamento} será executado periodicamente e
consistirá na execução da fase de treinamento para as técnicas de AM
(aprendizado de máquina). O depósito de dados \texttt{base ``treinada''}
representa uma base de dados com os parâmetros utilizados para representar o
\emph{conhecimento} dos algoritmos de AM (o conteúdo em si desta base depende
da técnica utilizada; SVMs, por exemplo, guardam alguns exemplos da base de
treinamento, já $k$-NN não guarda coisa alguma além dos exemplos). O processo
\texttt{Predição} recebe dois fluxos de dados, o primeiro é o das informações
de treinamento da \texttt{base ``treinada''}, o segundo é das mesmas
informações de CPU que vieram da etapa \texttt{Coleta}; este processo utiliza o
algoritmo de aprendizado para saber se alguma das máquinas virtuais que estão
sendo monitoradas tem possibilidade de saturar os recursos de processador das
máquinas hospeiras; é esse processo que envia os comandos necessários à
\libvirt{} visando migrar máquinas para outro hospedeiro que possa acomodá-lo.

% FIXME explicar esse tal pré-processamento

\begin{figure}[htp]
\centering
\includegraphics{img-diagrama-classes0.pdf}
\figinfo{Diagrama das principais classes do software proposto}{autoria própria}
\label{fig:diagramaclasses0}
\end{figure}

Na figura \ref{fig:diagramaclasses0} é apresentado um diagrama com as
principais classes do software. A classe \texttt{Projeto} representa uma
instância de todo o projeto e também é responsável pelo controle do ciclo
de vida das classes que fazem coleta, aprendizado e predição. Cada uma
destas classes possui apenas um método público, para que estes sejam
chamados apenas quando a classe \texttt{Projeto} considerar conveniente,
fazendo com que assim esta classe tenha um papel de escalonador do
software. As classes são a grosso modo um mapeamento dos processos
apresentados na figura \ref{fig:contexto1}, com excessão da classe
\texttt{InterfaceMMV}, que significa \emph{Interface para Monitor de
Máquinas Virtuais}, tem como propósito centralizar o acesso à \libvirt{},
facilitando a manutenção em caso de mudança de interface ou porte para
outra biblioteca. À excessão de \texttt{InterfaceMMV}, todas estas classes
são abstratas, pois devem ainda ser especializadas para cada uma das
técnicas de aprendizado que serão implementadas no projeto.

% diagrama de classes

\section{Detalhes de implementação}

O projeto será implementado na linguagem \emph{Python} \cite{rossum1995python}.
Esta possui tipagem dinâmica, suporta o paradigma de orientação a objetos e com
isso facilita a prototipagem de projetos \cite{lutz2006programming}.

O ambiente de desenvolvimento será baseado no sistema operacional Linux
\cite{morimoto2004entendendo}, que é a plataforma principal de
desenvolvimento e teste da \libvirt{}. Mesmo a biblioteca sendo acessível
de qualquer sistema operacional, a proximidade com o ambiente de
desenvolvimento diminui a probabilidade de encontrar incompatibilidade
entre ferramentas durante a fase de implementação. A distribuição Linux
utilizada será \emph{Mandriva Linux}\footnote{http://www.mandriva.com/},
que possui em sua base de pacotes todas as ferramentas necessárias para a
implementação. O pacote \texttt{python-libvirt} será utilizado para acessar
os módulos da \libvirt{}.

\section{Técnicas avaliadas}

Para as etapas de aprendizado e predição, serão avaliados alguns métodos
que acredita-se que terão bom desempenho na predição do comportamento das
máquinas virtuais.

\section{Avaliação de desempenho}\label{sec:desemp}

% utilizar SVM, K-NN, AR(16) (se for fácil de implementar)
% variar o tamanho das janelas de histórico
% utilizar uma instância do classificador para todas as VMs, versus
% utilizar uma instância nova para cada VM
